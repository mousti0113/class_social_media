<!-- Chat View -->
<div class="h-full flex flex-col bg-white dark:bg-gray-900 overflow-hidden">

  <!-- Header - altezza fissa -->
  <header class="flex-shrink-0 flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
    <!-- Freccia indietro (sempre visibile su mobile, nascosta su desktop se c'Ã¨ la sidebar) -->
    <button
      type="button"
      (click)="goBack()"
      class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400 transition-colors lg:hidden"
      aria-label="Torna alle conversazioni"
    >
      <lucide-icon [img]="ArrowLeftIcon" [size]="24" />
    </button>

    <!-- User info -->
    @if (otherUser(); as user) {
      <app-avatar
        [src]="user.profilePictureUrl"
        [name]="user.nomeCompleto"
        size="md"
        [status]="isOtherUserOnline() ? 'online' : 'offline'"
      />
      <div class="flex-1 min-w-0">
        <h2 class="font-semibold text-gray-900 dark:text-white truncate">
          {{ user.nomeCompleto }}
        </h2>
        <p class="text-sm" [class]="isOtherUserTyping() ? 'text-primary-400' : (isOtherUserOnline() ? 'text-green-500' : 'text-gray-500 dark:text-gray-400')">
          {{ onlineStatusText() }}
        </p>
      </div>
    } @else if (isLoading()) {
      <app-skeleton shape="circle" width="40px" height="40px" />
      <div class="flex-1 space-y-1">
        <app-skeleton width="120px" height="16px" />
        <app-skeleton width="60px" height="14px" />
      </div>
    }
  </header>

  <!-- Messages area - SOLO questa sezione scrolla -->
  <div
    #messagesContainer
    class="flex-1 min-h-0 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900"
  >
    <!-- Loading skeleton -->
    @if (isLoading()) {
      <div class="space-y-4">
        @for (i of [1, 2, 3, 4]; track i) {
          <div [class]="i % 2 === 0 ? 'flex justify-end' : 'flex justify-start'">
            <app-skeleton 
              [width]="i % 2 === 0 ? '200px' : '250px'" 
              height="60px" 
              borderRadius="16px"
            />
          </div>
        }
      </div>
    }

    <!-- Error state -->
    @if (error()) {
      <div class="flex flex-col items-center justify-center h-full text-center">
        <p class="text-gray-500 dark:text-gray-400">{{ error() }}</p>
      </div>
    }

    <!-- Empty state -->
    @if (!isLoading() && !error() && messages().length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-center">
        <p class="text-gray-500 dark:text-gray-400">
          Nessun messaggio. Inizia la conversazione!
        </p>
      </div>
    }

    <!-- Messages list -->
    @if (!isLoading() && messages().length > 0) {
      @for (message of messages(); track trackByMessageId($index, message)) {
        <app-message-bubble-component
          [contenuto]="message.contenuto"
          [imageUrl]="message.imageUrl"
          [createdAt]="message.createdAt"
          [isRead]="message.isRead"
          [isMine]="message.mittente.id === currentUserId()"
        />
      }

      <!-- Typing indicator -->
      @if (isOtherUserTyping()) {
        <div class="flex justify-start">
          <div class="bg-gray-200 dark:bg-gray-800 rounded-2xl rounded-bl-sm px-4 py-3">
            <div class="flex items-center gap-1">
              <span class="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
              <span class="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
              <span class="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
            </div>
          </div>
        </div>
      }
    }
  </div>

  <!-- Input area - altezza fissa, sempre in basso -->
  <div class="flex-shrink-0 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-4">
    <div class="flex items-end gap-3">
      <!-- Text input -->
      <div class="flex-1 relative">
        <input
          type="text"
          [value]="messageText()"
          (input)="onMessageInput($any($event.target).value)"
          (keydown)="onKeyDown($event)"
          placeholder="Scrivi un messaggio..."
          class="w-full px-4 py-3 pr-12 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"
          [disabled]="isSending()"
        />
      </div>

      <!-- Send button -->
      <button
        type="button"
        (click)="sendMessage()"
        [disabled]="!canSend()"
        class="flex-shrink-0 w-12 h-12 rounded-full bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 dark:disabled:bg-gray-700 disabled:cursor-not-allowed text-white flex items-center justify-center transition-colors"
        aria-label="Invia messaggio"
      >
        <lucide-icon [img]="SendIcon" [size]="20" />
      </button>
    </div>
  </div>
</div>
