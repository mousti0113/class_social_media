<article class="flex gap-3" [class.ml-10]="isReply()">
  <!-- Avatar -->
  <app-avatar
    [src]="comment().autore.profilePictureUrl"
    [alt]="comment().autore.nomeCompleto"
    [name]="comment().autore.nomeCompleto"
    [size]="isReply() ? 'sm' : 'md'"
    status="none"
    class="shrink-0"
  />

  <!-- Contenuto -->
  <div class="flex-1 min-w-0">
    <!-- Header -->
    <div class="flex items-start justify-between gap-2">
      <div class="min-w-0">
        <span class="font-semibold text-gray-900 dark:text-white">
          {{ comment().autore.nomeCompleto }}
        </span>
        <span class="text-gray-500 dark:text-gray-400 text-sm ml-1">
          &#64;{{ comment().autore.username }}
        </span>
        <span class="text-gray-400 dark:text-gray-500 text-sm mx-1">Â·</span>
        <app-time-ago
          class="text-gray-500 dark:text-gray-400 text-sm"
          [date]="comment().createdAt"
        />
      </div>

      <!-- Menu dropdown -->
      <app-dropdown placement="bottom-end" [minWidth]="10">
        <div
          trigger
          class="p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-100 dark:hover:text-gray-300 dark:hover:bg-gray-700 transition-colors cursor-pointer"
        >
          <lucide-icon [img]="MoreHorizontalIcon" [size]="16"></lucide-icon>
        </div>

        <div menu class="py-1">
          @if (isOwner()) {
            <button
              class="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"
              (click)="startEdit()"
            >
              <lucide-icon [img]="PencilIcon" [size]="14"></lucide-icon>
              Modifica
            </button>
            <button
              class="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
              (click)="deleteComment()"
            >
              <lucide-icon [img]="Trash2Icon" [size]="14"></lucide-icon>
              Elimina
            </button>
          } @else {
            <button
              class="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"
              (click)="hideComment()"
            >
              <lucide-icon [img]="EyeOffIcon" [size]="14"></lucide-icon>
              Nascondi
            </button>
          

            @if (isAdmin()) {
              <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
              <button
                class="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                (click)="deleteComment()"
              >
                <lucide-icon [img]="Trash2Icon" [size]="14"></lucide-icon>
                Elimina (Admin)
              </button>
            }
          }
        </div>
      </app-dropdown>
    </div>

    <!-- Contenuto o Edit mode -->
    @if (isEditing()) {
      <div class="mt-2 space-y-2">
        <textarea
          class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20"
          rows="3"
          [value]="editContent()"
          (input)="onEditInput($event)"
        ></textarea>
        <div class="flex gap-2">
          <button
            class="px-3 py-1.5 text-sm font-medium text-white bg-primary-500 rounded-lg hover:bg-primary-600 transition-colors"
            (click)="saveEdit()"
          >
            Salva
          </button>
          <button
            class="px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
            (click)="cancelEdit()"
          >
            Annulla
          </button>
        </div>
      </div>
    } @else {
      <p class="mt-1 text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap break-words">
        <app-safe-mention-text [content]="comment().contenuto" />
      </p>
    }

    <!-- Azioni -->
    @if (!isEditing()) {
      <div class="flex items-center gap-4 mt-2">
        <!-- Rispondi -->
        @if (canReply()) {
          <button
            class="flex items-center gap-1.5 text-sm text-gray-500 hover:text-primary-500 dark:text-gray-400 transition-colors"
            (click)="startReply()"
          >
            <lucide-icon [img]="ReplyIcon" [size]="14"></lucide-icon>
            Rispondi
          </button>
        }

        <!-- Toggle risposte -->
        @if (hasReplies()) {
          <button
            class="flex items-center gap-1.5 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors"
            (click)="toggleReplies()"
          >
            <lucide-icon 
              [img]="showReplies() ? ChevronUpIcon : ChevronDownIcon" 
              [size]="14"
            ></lucide-icon>
            {{ repliesCount() }} {{ repliesCount() === 1 ? 'risposta' : 'risposte' }}
          </button>
        }
      </div>
    }

    <!-- Risposte (ricorsivo) -->
    @if (hasReplies() && showReplies()) {
      <div class="mt-4 space-y-4">
        @for (risposta of comment().risposte; track risposta.id) {
          <app-comment
            [comment]="risposta"
            [postId]="postId()"
            [level]="level() + 1"
            (reply)="onNestedReply($event)"
            (deleted)="onReplyDeleted($event)"
            (updated)="onReplyUpdated($event)"
          />
        }
      </div>
    }
  </div>
</article>