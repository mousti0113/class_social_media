<div class="space-y-2">
  <!-- Reply indicator -->
  @if (isReplyMode()) {
    <div class="flex items-center justify-between px-4 py-2.5 bg-primary-50 dark:bg-primary-900/20 rounded-xl border border-primary-200 dark:border-primary-800">
      <div class="flex items-center gap-2">
        <lucide-icon [img]="ReplyIcon" [size]="16" class="text-primary-600 dark:text-primary-400"></lucide-icon>
        <span class="text-sm text-primary-700 dark:text-primary-300">
          Rispondi a
          <span class="font-semibold">
            &#64;{{ replyTo()?.autore?.username }}
          </span>
        </span>
      </div>
      <button
        type="button"
        class="p-1.5 rounded-full text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-primary-800 transition-colors"
        (click)="cancel()"
      >
        <lucide-icon [img]="XIcon" [size]="16"></lucide-icon>
      </button>
    </div>
  }

  <!-- Form -->
  <div class="flex gap-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl">
    <!-- Avatar utente corrente -->
    @if (currentUser(); as user) {
      <app-avatar
        [src]="user.profilePictureUrl"
        [alt]="user.nomeCompleto"
        [name]="user.nomeCompleto"
        size="sm"
        status="online"
        class="shrink-0 mt-1"
      />
    }

    <!-- Input area -->
    <div class="flex-1 flex gap-2 relative">
      <div class="flex-1 relative">
        <textarea
          #textareaEl
          appAutoResize
          [minRows]="1"
          [maxRows]="5"
          class="w-full px-4 py-2.5 text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all placeholder:text-gray-400"
          [placeholder]="dynamicPlaceholder()"
          [value]="content()"
          (input)="onInput($event)"
          (keydown)="onKeydown($event)"
        ></textarea>

        <!-- Mention Autocomplete Dropdown -->
        <app-mention-autocomplete-component
          #mentionAutocomplete
          [searchTerm]="mentionSearchTerm()"
          [show]="showMentionDropdown()"
          [position]="{ top: -220, left: 0 }"
          (userSelected)="onMentionSelected($event)"
          (close)="closeMentionDropdown()"
        />
      </div>

      <!-- Submit button -->
      <button
        type="button"
        class="shrink-0 p-2.5 rounded-xl transition-all self-end"
        [class]="isSubmitDisabled()
          ? 'text-gray-300 dark:text-gray-600 cursor-not-allowed bg-gray-200 dark:bg-gray-800'
          : 'text-white bg-primary-500 hover:bg-primary-600 hover:scale-105'"
        [disabled]="isSubmitDisabled()"
        (click)="submit()"
      >
        <lucide-icon [img]="SendIcon" [size]="18"></lucide-icon>
      </button>
    </div>
  </div>

  <!-- Hint -->
  <p class="text-xs text-gray-400 dark:text-gray-500 text-right px-2">
    Premi Ctrl + Invio per inviare
  </p>
</div>